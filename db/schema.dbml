// DBML for an Extendable Smart Farming Platform
// Version 3.3 - Final Schema with Updated File Path References in Notes

// --- Core Identity & Access Management ---

Table "farmers" [headercolor: #1E69FD] {
  "id" int [pk, increment]
  "first_name" varchar [not null]
  "last_name" varchar [not null]
  "email" varchar [unique, not null]
  "phone_number" varchar [unique]
  "address" varchar
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'Represents the legal owner or primary stakeholder of a farm.'
}

Table "third_party_providers" [headercolor: #1E69FD] {
  "id" int [pk, increment]
  "company_name" varchar [not null]
  "service_type" varchar // e.g., 'Agronomy Consulting', 'Data Provider'
  "contact_email" varchar [unique, not null]
  "website" varchar
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'For external companies or consultants who may require access to farm data.'
}

Table "users" [headercolor: #1E69FD] {
  "id" int [pk, increment]
  "username" varchar [unique, not null]
  "password_hash" varchar [not null]
  "role" "user_role" [not null]
  "is_active" boolean [not null, default: true]
  "last_login" timestamp
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  "farmer_id" int [ref: > farmers.id]
  "third_party_provider_id" int [ref: > third_party_providers.id]
  Note: 'Central authentication table. A user represents an individual who can log in. A CHECK constraint should ensure only one of farmer_id or third_party_provider_id is set. Both can be NULL for system-level users.'
}

Enum "user_role" {
  "system_admin"
  "farm_owner"
  "farm_manager"
  "worker"
  "third_party"
}

Table "user_farm_access" [headercolor: #1E69FD] {
  "user_id" int [pk, ref: > users.id]
  "farm_id" int [pk, ref: > farms.id]
  "access_level" "access_level_enum" [not null]
  "granted_at" timestamp [not null, default: `now()`]
  Note: 'Junction table to manage which user can access which farm and at what level. This is key for multi-tenancy.'
}

Enum "access_level_enum" {
  "owner"
  "manager"
  "viewer"
}

Table "api_keys" [headercolor: #1E69FD] {
  "id" int [pk, increment]
  "key_hash" varchar [unique, not null]
  "provider_id" int [ref: > third_party_providers.id, not null]
  "scopes" JSONB [not null] // e.g., ["read:missions:farm_123"]
  "expires_at" timestamp
  "last_used_at" timestamp
  "created_at" timestamp [not null, default: `now()`]
  Note: 'Manages programmatic access for third-party services. Scopes define what data the key is authorized to access.'
}

// --- Farm & Field Structure ---

Table "farms" [headercolor: #2D862B] {
  "id" int [pk, increment]
  "farmer_id" int [ref: > farmers.id, not null]
  "name" varchar [not null]
  "location" geometry
  "area" numeric(10, 2)
  "unit" "area_unit"
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'Represents a single farm. The farmer_id denotes the primary owner.'
}

Enum "area_unit" {
  "hectare"
  "acre"
  "square_meter"
}

Table "crop_catalog" [headercolor: #2D862B] {
  "id" int [pk, increment]
  "eppo_code" varchar [unique, not null]
  "scientific_name" varchar
  "common_name" varchar
  "type" varchar
  Note: 'A standardized dictionary for crops, weeds, and other plants. Using a recognized standard like EPPO codes (e.g., "DAUCA" for Carrot) is crucial for interoperability.'
}

Table "fields" [headercolor: #2D862B] {
  "id" int [pk, increment]
  "farm_id" int [ref: > farms.id, not null]
  "name" varchar
  "crop_id" int [ref: > crop_catalog.id]
  "soil_type" varchar
  "area" numeric(10, 2)
  "unit" "area_unit"
  "polygon" geometry [not null]
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'A single, continuous piece of land within a farm. The `polygon` field is essential for storing its exact geospatial boundaries.'
}

// --- IoT & Robotics Hardware ---

Table "devices" [headercolor: #5534C1] {
  "id" int [pk, increment]
  "installation_id" int [ref: > installations.id]
  "name" varchar
  "type" "device_type" [not null]
  "model" varchar
  "manufacturer" varchar
  "serial_number" varchar [unique]
  "firmware_version" varchar
  "last_seen" timestamp
  "status" "device_status" [not null, default: 'offline']
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'Master table for all physical hardware assets. Specific device types like robots have their own dedicated tables with more attributes.'
}

Enum "device_type" {
  "sensor"
  "actuator"
  "camera"
  "controller"
  "robot"
}

Table "robots" [headercolor: #5534C1] {
  "id" int [pk, increment]
  "device_id" int [ref: > devices.id, unique, not null]
  "robot_name" varchar [unique, not null]
  "software_version" varchar
  Note: 'Extends the `devices` table with attributes specific to autonomous robots, such as their unique name and software version.'
}

Table "installations" [headercolor: #5534C1] {
  "id" int [pk, increment]
  "field_id" int [ref: > fields.id, not null]
  "type" "installation_type" [not null]
  "name" varchar
  "location" point [not null]
  "installation_date" DATE
  "status" "installation_status" [not null, default: 'active']
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'Represents a physical installation in a field, which can host multiple devices. For example, a "Weather Station" might host temperature and humidity sensors.'
}

Enum "installation_type" {
  "weather_station"
  "irrigation_system"
  "drone_station"
  "sensor_hub"
}

Enum "installation_status" {
  "active"
  "inactive"
  "maintenance"
  "error"
}

Enum "device_status" {
  "online"
  "offline"
  "error"
}

// --- Missions & Operations Data ---

Table "missions" [headercolor: #A934C1] {
  "id" bigint [pk, increment]
  "robot_id" int [not null, ref: > robots.id]
  "field_id" int [not null, ref: > fields.id]
  "user_id" int [ref: > users.id]
  "mission_type" "mission_type_enum" [not null]
  "start_time" timestamptz [not null]
  "end_time" timestamptz [not null]
  "travelled_distance_m" numeric(10, 2)
  "covered_area_m2" numeric(10, 2)
  "sprayed_fluid_l" numeric(10, 3)
  "target_fluid_density_lpha" numeric(10, 2)
  "setpoint_pressure_bar" numeric(5, 2)
  "cultivation_method" varchar
  "inference_model" varchar
  "context_crop_id" int [ref: > crop_catalog.id]
  "target_id" int [ref: > crop_catalog.id]
  "min_latitude" numeric(12, 9)
  "max_latitude" numeric(12, 9)
  "min_longitude" numeric(12, 9)
  "max_longitude" numeric(12, 9)
  "crop_weed_correlation" numeric(5, 4)
  "weed_liquid_correlation" numeric(5, 4)
  "created_at" timestamp [not null, default: `now()`]
  Note: 'Core table for logging robotic operations. It stores the summary data from files like `UC2/Ecorobotix/mission_data.json` and `UC2/Ecorobotix/mission_metadata.json`.'
}

Enum "mission_type_enum" {
  "spraying"
  "scouting"
  "thinning"
  "seeding"
  "harvesting"
}

Table "robot_state_timeseries" [headercolor: #A934C1] {
  "mission_id" bigint [ref: > missions.id, not null]
  "timestamp" timestamptz [not null]
  "system_state" varchar
  "latitude_rad" "double precision"
  "longitude_rad" "double precision"
  "pose_x_m" numeric
  "pose_y_m" numeric
  "pose_theta_rad" numeric
  "speed_x_mps" numeric
  "speed_y_mps" numeric
  "speed_omega_radps" numeric
  "unit0_fluid_l" numeric
  "unit1_fluid_l" numeric
  "unit2_fluid_l" numeric
  "target_coverage_percent" numeric
  "avoid_coverage_percent" numeric
  indexes { (mission_id, timestamp) [pk] }
  Note: 'Stores high-volume, high-frequency state data from a robot during a mission (from `UC2/Ecorobotix/mission_state_time_series.csv`). For massive scale, this table is a primary candidate for a dedicated time-series database like TimescaleDB.'
}

Table "mission_images" [headercolor: #A934C1] {
  "id" bigint [pk, increment]
  "mission_id" bigint [ref: > missions.id, not null]
  "timestamp" timestamptz [not null]
  "image_url" varchar [not null]
  "latitude" numeric(12, 9)
  "longitude" numeric(12, 9)
  "camera_id" int
  Note: 'A log of all images captured during a mission, linking them to a specific time and place. See sample: `UC5 & UC6/EUT/thinning_image.png`'
}

Table "image_predictions" [headercolor: #A934C1] {
  "detection_id" UUID [pk, default: `uuid_generate_v4()`]
  "image_id" bigint [ref: > mission_images.id, not null]
  "class_name" varchar [not null]
  "confidence" numeric(5, 4) [not null]
  "x" numeric [not null]
  "y" numeric [not null]
  "width" numeric [not null]
  "height" numeric [not null]
  Note: 'Stores the output of computer vision models (e.g., from `UC5 & UC6/EUT/thinning_output.json`). Each row is a single detected object within a mission image.'
}

Table "agri_events" [headercolor: #A934C1] {
  "mission_id" bigint [ref: > missions.id]
  "timestamp" timestamptz [not null]
  "latitude" numeric(12, 9) [not null]
  "longitude" numeric(12, 9) [not null]
  "altitude" numeric
  "event_type" varchar [not null]
  "event_value" numeric [not null]
  indexes { (mission_id, timestamp, event_type) [pk] }
  Note: 'Flexible table for other time-series data streams from a mission, like the sample detection counts from `UC3 & UC4/sample_file_uc3_uc4.csv`.'
}

// --- Sensor Data & Automation ---

Table "measurement_types" [headercolor: #D95B16] {
  "id" int [pk, increment]
  "name" varchar [unique, not null]
  "default_unit" varchar [not null]
  "description" TEXT
  Note: 'Defines the standardized types of sensor measurements that can be recorded, e.g., "temperature", "ph_level".'
}

Table "sensor_readings" [headercolor: #D95B16] {
  "timestamp" timestamptz [not null]
  "device_id" int [ref: > devices.id, not null]
  "measurement_type_id" int [ref: > measurement_types.id, not null]
  "value" numeric(10, 3) [not null]
  Indexes { 
    (device_id, timestamp) [pk] 
    (measurement_type_id, timestamp) }
  Note: 'Stores time-series data from stationary sensors. Similar to robot_state_timeseries, this can grow very large and may benefit from a time-series database solution in the long term.'
}

Table "automations" [headercolor: #D95B16] {
  "id" int [pk, increment]
  "farm_id" int [ref: > farms.id, not null]
  "name" varchar [not null]
  "description" TEXT
  "is_active" boolean [not null, default: true]
  "created_by_user_id" int [ref: > users.id]
  "created_at" timestamp [not null, default: `now()`]
  "updated_at" timestamp [not null]
  Note: 'Defines a named automation rule, which consists of triggers and actions.'
}

Table "automation_triggers" [headercolor: #D95B16] {
  "id" int [pk, increment]
  "automation_id" int [ref: > automations.id, not null]
  "device_id" int [ref: > devices.id, not null]
  "measurement_type_id" int [ref: > measurement_types.id, not null]
  "operator" "trigger_operator" [not null]
  "threshold_value" numeric(10, 2) [not null]
  Note: 'The "IF" part of an automation rule. e.g., IF sensor "X" temperature > 30Â°C.'
}

Enum "trigger_operator" {
  ">"
  ">="
  "<"
  "<="
  "=="
  "!="
}

Table "automation_actions" [headercolor: #D95B16] {
  "id" int [pk, increment]
  "automation_id" int [ref: > automations.id, not null]
  "target_device_id" int [ref: > devices.id, not null]
  "action_command" varchar [not null]
  "action_value" varchar
  "execution_order" int [not null, default: 1]
  Note: 'The "THEN" part of an automation rule. e.g., THEN turn on actuator "Y".'
}

Table "automation_runs" [headercolor: #D95B16] {
  "id" bigint [pk, increment]
  "automation_id" int [ref: > automations.id, not null]
  "started_at" timestamp [not null, default: `now()`]
  "finished_at" timestamp
  "status" "run_status" [not null]
  "logs" TEXT
  Note: 'A log of every time an automation is triggered and executed.'
}

Enum "run_status" {
  "success"
  "failed"
  "running"
  "skipped"
}

// --- Table Groups Definition ---

// TableGroup "Identity & Access Management" [color: #1E69FD] {
//   farmers
//   third_party_providers
//   users
//   user_farm_access
//   api_keys
// }

// TableGroup "Farm & Field Structure" {
//   farms
//   fields
//   crop_catalog
// }

// TableGroup "IoT & Robotics Hardware" {
//   devices
//   robots
//   installations
// }

// TableGroup "Missions & Operations Data" [color: #A15CF5] {
//   missions
//   robot_state_timeseries
//   mission_images
//   image_predictions
//   agri_events
// }

// TableGroup "Sensor Data & Automation" {
//   measurement_types
//   sensor_readings
//   automations
//   automation_triggers
//   automation_actions
//   automation_runs
// }
